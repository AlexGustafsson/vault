## Managing authority information

The following privileged endpoints allow the operator to control information
about the core contents of certificates and to perform privileged operations
like rotating the CRLs or performing tidy operations.

### List roles

Refer to the [earlier section](#list-roles) for more information about
listing roles.

### Create/Update role

This endpoint creates or updates the role definition. Note that the
`allowed_domains`, `allow_subdomains`, `allow_glob_domains`, and
`allow_any_name` attributes are additive; between them nearly and across
multiple roles nearly any issuing policy can be accommodated. `server_flag`,
`client_flag`, and `code_signing_flag` are additive as well. If a client
requests a certificate that is not allowed by the CN policy in the role, the
request is denied.

| Method  | Path               |
| :------ | :----------------- |
| `POST`  | `/pki/roles/:name` |
| `PATCH` | `/pki/roles/:name` |

~> **Note** `POST`ing to this endpoint when the role already exists causes
   Vault to overwrite the contents of the role, using the provided request
   data (and any defaults for elided parameters). It does not update only
   the provided fields.<br /><br />
   Since Vault 1.11.0, Vault supports the PATCH operation to this endpoint,
   using the [JSON patch format](https://datatracker.ietf.org/doc/html/rfc6902)
   supported by KVv2, allowing update of specific fields. Note that
   `vault write` uses `POST`.

#### Parameters

- `name` `(string: <required>)` - Specifies the name of the role to create. This
  is part of the request URL.

- `issuer_ref`: `(string: "default")` - Specifies the default issuer of this
  request. May be the value `default`, a name, or an issuer ID. Use ACLs to
  prevent access to the `/pki/issuer/:issuer_ref/{issue,sign}/:name` paths
  to prevent users overriding the role's `issuer_ref` value.

~> Note: This parameter is stored as-is; if the reference is to a name, it
   is **not** resolve to an identifier. Deletion of issuers (or updating their
   names) **may** result in issuance failing or using an unexpected issuer.

~> **Note**: existing roles from previous Vault versions are migrated to use
   the `issuer_ref=default`.

- `ttl` `(string: "")` - Specifies the Time To Live value to be used for the
  validity period of the requested certificate, provided as a string duration
  with time suffix. Hour is the largest suffix. The value specified is strictly
  used for future validity. If not set, uses the system default value or the
  value of `max_ttl`, whichever is shorter. See `not_after` as an alternative
  for setting an absolute end date (rather than a relative one).

- `max_ttl` `(string: "")` - Specifies the maximum Time To Live provided as a
  string duration with time suffix. Hour is the largest suffix. If not set,
  defaults to the system maximum lease TTL.

- `allow_localhost` `(bool: true)` - Specifies if clients can request
  certificates for `localhost` as one of the requested common names. This is
  useful for testing and to allow clients on a single host to talk securely.

~> **Note**: This strictly applies to `localhost` and `localdomain` when this
   option is enabled. Additionally, even if this option is disabled, if either
   name is included in `allowed_domains`, the match rules for that option
   could permit issuance of a certificate for `localhost`.

- `allowed_domains` `(list: [])` - Specifies the domains this role is allowed
  to issue certificates for. This is used with the `allow_bare_domains`,
  `allow_subdomains`, and `allow_glob_domains` options to determine the type
  of matching between these domains and the values of common name, DNS-typed
  SAN entries, and Email-typed SAN entries. When `allow_any_name` is used,
  this attribute has no effect.

~> **Note**: The three options `allow_bare_domains`, `allow_subdomains`, and
   `allow_glob_domains` are each independent of each other. That is, at least
   one type of allowed matching must describe the relationship between the
   `allowed_domains` list and the names on the issued certificate. For example,
   given `allowed_domain=foo.*.example.com` and `allow_subdomains=true` and
   `allow_glob_domains=true`, a request for `bar.foo.baz.example.com` won't
   be permitted, even though it `foo.baz.example.com` matches the glob
   `foo.*.example.com` and `bar` is a subdomain of that.

- `allowed_domains_template` `(bool: false)` - When set, `allowed_domains`
  may contain templates, as with [ACL Path Templating](/vault/docs/concepts/policies).
  Non-templated domains are also still permitted.

- `allow_bare_domains` `(bool: false)` - Specifies if clients can request
  certificates matching the value of the actual domains themselves; e.g. if a
  configured domain set with `allowed_domains` is `example.com`, this allows
  clients to actually request a certificate containing the name `example.com` as
  one of the DNS values on the final certificate. In some scenarios, this can be
  considered a security risk. Note that when an `allowed_domain` field contains
  a potential wildcard character (for example, `allowed_domains=*.example.com`)
  and `allow_bare_domains` and `allow_wildcard_certificates` are both enabled,
  issuance of a wildcard certificate for `*.example.com` will be permitted.

- `allow_subdomains` `(bool: false)` - Specifies if clients can request
  certificates with CNs that are subdomains of the CNs allowed by the other role
  options. _This includes wildcard subdomains._ For example, an
  `allowed_domains` value of `example.com` with this option set to true will
  allow `foo.example.com` and `bar.example.com` as well as `*.example.com`. To
  restrict issuance of wildcards by this option, see `allow_wildcard_certificates`
  below. This option is redundant when using the `allow_any_name` option.

- `allow_glob_domains` `(bool: false)` - Allows names specified in
  `allowed_domains` to contain glob patterns (e.g. `ftp*.example.com`). Clients
  will be allowed to request certificates with names matching the glob
  patterns.

~> **Note**: These globs behave like shell-style globs and can match
  across multiple domain parts. For example, `allowed_domains=*.example.com`
  with `allow_glob_domains` enabled will match not only `foo.example.com` but
  also `baz.bar.foo.example.com`.

~> **Warning**: Glob patterns will match wildcard domains and permit their
   issuance unless otherwise restricted by `allow_wildcard_certificates`. For
   instance, with `allowed_domains=*.*.example.com` and both `allow_glob_domains`
   and `allow_wildcard_certificates` enabled, we will permit the issuance of
   a wildcard certificate for `*.foo.example.com`.

- `allow_wildcard_certificates` `(bool: true)` - Allows the issuance of
  certificates with [RFC 6125](https://tools.ietf.org/html/rfc6125) wildcards
  in the CN field. When set to `false`, this prevents wildcards from being
  issued even if they would've been allowed by an option above. We support
  the following four wildcard types:

  - `*.example.com`, a single wildcard as the entire left-most label,
  - `foo*.example.com`, a single suffixed wildcard in the left-most label,
  - `*foo.example.com`, a single prefixed wildcard in the left-most label, and
  - `f*o.example.com`, a single interior wildcard in the left-most label.

- `allow_any_name` `(bool: false)` - Specifies if clients can request any CN.
  Useful in some circumstances, but make sure you understand whether it is
  appropriate for your installation before enabling it. Note that both
  `enforce_hostnames` and `allow_wildcard_certificates` are still checked,
  which may introduce limitations on issuance with this option.

- `enforce_hostnames` `(bool: true)` - Specifies if only valid host names are
  allowed for CNs, DNS SANs, and the host part of email addresses.

- `allow_ip_sans` `(bool: true)` - Specifies if clients can request IP Subject
  Alternative Names. No authorization checking is performed except to verify
  that the given values are valid IP addresses.

- `allowed_uri_sans` `(string: "")` - Defines allowed URI Subject
  Alternative Names. No authorization checking is performed except to verify
  that the given values are valid URIs. This can be a comma-delimited list or
  a JSON string slice. Values can contain glob patterns (e.g.
  `spiffe://hostname/*`).

- `allowed_uri_sans_template` `(bool: false)` - When set, `allowed_uri_sans`
  may contain templates, as with [ACL Path Templating](/vault/docs/concepts/policies).
  Non-templated domains are also still permitted.

- `allowed_other_sans` `(string: "")` - Defines allowed custom OID/UTF8-string
  SANs. This can be a comma-delimited list or a JSON string slice, where
  each element has the same format as OpenSSL: `<oid>;<type>:<value>`, but
  the only valid type is `UTF8` or `UTF-8`. The `value` part of an element
  may be a `*` to allow any value with that OID.
  Alternatively, specifying a single `*` will allow any `other_sans` input.

- `allowed_serial_numbers` `(string: "")` - If set, an array of allowed serial
  numbers to be requested during certificate issuance. These values support
  shell-style globbing. When empty, custom-specified serial numbers will be
  forbidden. It is strongly recommended to allow Vault to generate random
  serial numbers instead.

- `server_flag` `(bool: true)` - Specifies if certificates are flagged for
  server authentication use. See [RFC 5280 Section 4.2.1.12](https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.12)
  for information about the Extended Key Usage field.

- `client_flag` `(bool: true)` - Specifies if certificates are flagged for
  client authentication use. See [RFC 5280 Section 4.2.1.12](https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.12)
  for information about the Extended Key Usage field.

- `code_signing_flag` `(bool: false)` - Specifies if certificates are flagged
  for code signing use. See [RFC 5280 Section 4.2.1.12](https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.12)
  for information about the Extended Key Usage field.

- `email_protection_flag` `(bool: false)` - Specifies if certificates are
  flagged for email protection use. See [RFC 5280 Section 4.2.1.12](https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.12)
  for information about the Extended Key Usage field.

- `key_type` `(string: "rsa")` - Specifies the type of key to generate for
  generated private keys and the type of key expected for submitted CSRs.
  Currently, `rsa`, `ec`, and `ed25519` are supported, or when signing
  existing CSRs, `any` can be specified to allow keys of either type
  and with any bit size (subject to >=2048 bits for RSA keys or >= 224 for EC keys).
  When `any` is used, this role cannot generate certificates and can only
  be used to sign CSRs.

~> **Note**: In FIPS 140-2 mode, the following algorithms are not certified
   and thus should not be used: `ed25519`.

- `key_bits` `(int: 0)` - Specifies the number of bits to use for the
  generated keys. Allowed values are 0 (universal default); with
  `key_type=rsa`, allowed values are: 2048 (default), 3072, or
  4096; with `key_type=ec`, allowed values are: 224, 256 (default),
  384, or 521; ignored with `key_type=ed25519` or in signing operations
  when `key_type=any`.

- `signature_bits` `(int: 0)` - Specifies the number of bits to use in
  the signature algorithm; accepts 256 for SHA-2-256, 384 for SHA-2-384,
  and 512 for SHA-2-512. Defaults to 0 to automatically detect based
  on issuer's key length (SHA-2-256 for RSA keys, and matching the curve size
  for NIST P-Curves).

~> **Note**: ECDSA and Ed25519 issuers do not follow configuration of the
   `signature_bits` value; only RSA issuers will change signature types
   based on this parameter.

- `use_pss` `(bool: false)` - Specifies whether or not to use PSS signatures
  over PKCS#1v1.5 signatures when a RSA-type issuer is used. Ignored for
  ECDSA/Ed25519 issuers.

- `key_usage` `(list: ["DigitalSignature", "KeyAgreement", "KeyEncipherment"])` -
  Specifies the allowed key usage constraint on issued certificates. Valid
  values can be found at https://golang.org/pkg/crypto/x509/#KeyUsage - simply
  drop the `KeyUsage` part of the value. Values are not case-sensitive. To
  specify no key usage constraints, set this to an empty list. See
  [RFC 5280 Section 4.2.1.3](https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.3)
  for more information about the Key Usage field.

- `ext_key_usage` `(list: [])` -
  Specifies the allowed extended key usage constraint on issued certificates. Valid
  values can be found at https://golang.org/pkg/crypto/x509/#ExtKeyUsage - simply
  drop the `ExtKeyUsage` part of the value. Values are not case-sensitive. To
  specify no key usage constraints, set this to an empty list. See
  [RFC 5280 Section 4.2.1.12](https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.12)
  for information about the Extended Key Usage field.

- `ext_key_usage_oids` `(string: "")` - A comma-separated string or list of extended
  key usage oids. Useful for adding EKUs not supported by the Go standard library.

- `use_csr_common_name` `(bool: true)` - When used with the CSR signing
  endpoint, the common name in the CSR will be used instead of taken from the
  JSON data. This does not include any requested SANs in the CSR; use
  `use_csr_sans` for that.

- `use_csr_sans` `(bool: true)` - When used with the CSR signing endpoint, the
  subject alternate names in the CSR will be used instead of taken from the JSON
  data. This does not include the common name in the CSR; use
  `use_csr_common_name` for that.

- `ou` `(string: "")` - Specifies the OU (OrganizationalUnit) values in the
  subject field of issued certificates. This is a comma-separated string or
  JSON array.

- `organization` `(string: "")` - Specifies the O (Organization) values in the
  subject field of issued certificates. This is a comma-separated string or
  JSON array.

- `country` `(string: "")` - Specifies the C (Country) values in the
  subject field of issued certificates. This is a comma-separated string or
  JSON array.

- `locality` `(string: "")` - Specifies the L (Locality) values in the
  subject field of issued certificates. This is a comma-separated string or
  JSON array.

- `province` `(string: "")` - Specifies the ST (Province) values in the
  subject field of issued certificates. This is a comma-separated string or
  JSON array.

- `street_address` `(string: "")` - Specifies the Street Address values in the
  subject field of issued certificates. This is a comma-separated string or
  JSON array.

- `postal_code` `(string: "")` - Specifies the Postal Code values in the
  subject field of issued certificates. This is a comma-separated string or
  JSON array.

- `generate_lease` `(bool: false)` - Specifies if certificates issued/signed
  against this role will have Vault leases attached to them. Certificates can be
  added to the CRL by `vault revoke <lease_id>` when certificates are associated
  with leases. It can also be done using the `pki/revoke` endpoint. However,
  when lease generation is disabled, invoking `pki/revoke` would be the only way
  to add the certificates to the CRL. When large number of certificates are
  generated with long lifetimes, it is recommended that lease generation be
  disabled, as large amount of leases adversely affect the startup time of Vault.

- `no_store` `(bool: false)` - If set, certificates issued/signed against this
  role will not be stored in the storage backend. This can improve performance
  when issuing large numbers of certificates. However, certificates issued in
  this way cannot be enumerated or revoked via serial number. Certificates may
  still be revoked via [BYOC revocation](#certificate-1).
  This option is recommend only for certificates that are non-sensitive,
  extremely short-lived, or have high volume/turn-over that would prohibit
  storage. This option implies a value of `false` for `generate_lease`.

- `require_cn` `(bool: true)` - If set to false, makes the `common_name` field
  optional while generating a certificate.

- `policy_identifiers` `(list: [])` - A comma-separated string or list of policy
  OIDs.

- `basic_constraints_valid_for_non_ca` `(bool: false)` - Mark Basic Constraints
  valid when issuing non-CA certificates.

- `not_before_duration` `(duration: "30s")` - Specifies the duration by which to
  backdate the NotBefore property. This value has no impact in the validity period
  of the requested certificate, specified in the `ttl` field.

- `not_after` `(string)` - Set the Not After field of the certificate with
  specified date value. The value format should be given in UTC format
  `YYYY-MM-ddTHH:MM:SSZ`. Supports the Y10K end date for IEEE 802.1AR-2018
  standard devices, `9999-12-31T23:59:59Z`.

- `cn_validations` `(list: ["email", "hostname"])` - Validations to run on the
  Common Name field of the certificate. Valid values include:

   - `email`, to ensure the Common Name is an email address (contains an `@` sign),
   - `hostname`, to ensure the Common Name is a hostname (otherwise).

  Multiple values can be separated with a comma or specified as a list and use
  OR semantics (either email or hostname in the CN are allowed). When the
  special value "disabled" is used (must be specified alone), none of the usual
  validation is run (including but not limited to `allowed_domains` and basic
  correctness validation around email addresses and domain names). This allows
  non-standard CNs to be used verbatim from the request.

- `allowed_user_ids` `(string: "")` - Comma separated, globbing list of User ID
  Subject components to allow on requests. By default, no user IDs are allowed.
  Use the bare wildcard `*` value to allow any value. See also the `user_ids`
  request parameter.

#### Sample payload

```json
{
  "allowed_domains": ["example.com"],
  "allow_subdomains": true
}
```

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    --request POST \
    --data @payload.json \
    http://127.0.0.1:8200/v1/pki/roles/my-role
```

### Read role

Refer to the [earlier section](#read-role) for more information about
reading roles.

### Delete role

This endpoint deletes the role definition. Deleting a role **does not**
revoke certificates previously issued under this role.

| Method   | Path               |
| :------- | :----------------- |
| `DELETE` | `/pki/roles/:name` |

#### Parameters

- `name` `(string: <required>)` - Specifies the name of the role to delete. This
  is part of the request URL.

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    --request DELETE \
    http://127.0.0.1:8200/v1/pki/roles/my-role
```

### Read Certificate Issuance External Policy Service (CIEPS) configuration <EnterpriseAlert inline="true" />

This endpoint reads the Certificate Issuance External Policy Service
(CIEPS) engine <EnterpriseAlert inline="true" /> connection properties.

On top of the configuration parameters documented below, this endpoint
returns the following parameters:

 - `external_service_last_updated` - An RFC 3339 timestamp indicating when the
   configuration was last modified.

 - `external_service_validated` - Indicates whether a successful connection to
   the external policy engine has been made under this configuration.

 - `last_successful_request` - Timestamp of the last successful request to
   the external policy engine.

Note that the last two parameters are node-specific and will be reset
whenever the mount reloads (e.g., leadership election or seal/unseal).

| Method | Path                          |
| :----- | :---------------------------- |
| `GET`  | `/pki/config/external-policy` |

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    --request GET \
    --data @payload.json \
    http://127.0.0.1:8200/v1/pki/config/external-policy
```

#### Sample Response

```
{
  "data": {
    "enabled": false,
    "entity_jmsepath": "",
    "external_service_last_updated": "0001-01-01T00:00:00Z",
    "external_service_url": "",
    "external_service_validated": false,
    "group_jmsepath": "",
    "last_successful_request": "",
    "timeout": 15000000000,
    "trusted_ca": "",
    "trusted_leaf_certificate_bundle": "",
    "vault_client_cert_bundle": ""
  },
}

```

### Set Certificate Issuance External Policy Service (CIEPS) configuration <EnterpriseAlert inline="true" />

This endpoint allows enabling the Certificate Issuance External Policy Service
(CIEPS) <EnterpriseAlert inline="true" /> engine and configuring connection
properties.

| Method | Path                          |
| :----- | :---------------------------- |
| `POST` | `/pki/config/external-policy` |

#### Parameters

 - `enabled` `(bool: false)` - Enables or disables the external policy
   service. When disabled, issuance mechanisms under `external-policy`
   paths (e.g., `/pki/external-policy/sign/:policy`) will not work.

 - `entity_jmespath` `(string: "")` - A JMESPath expression that will select
   and filter entity metadata to the service. By default no entity metadata
   beyond the entity id is sent, use "@" to send all information.

 - `external_service_url` `(string: <required>)` - URI to the external
   policy engine. Must use the `https://` scheme.

 - `group_jmespath` `(string: "")` - A JMESPath expression that will select
   and filter entity group metadata to the service. By default no group entity
   metadata is sent, use "@" to send all information.

 - `timeout` `(string: "")` - This is how long any particular API request
   should wait for a timeout at various layers of the stack. Defaults to
   `15s`.

 - `trusted_ca` `(string: "")` - A PEM bundle of trusted CAs to verify the
   certificates presented by the external policy engine against. Optional;
   one of `trusted_ca` or `trusted_leaf_certificate_bundle` must be specified.

 - `trusted_leaf_certificate_bundle` `(string: "")` - A PEM bundle of pinned
   non-CA leaf certificates that must be presented by the external policy
   engine. Optional; one of `trusted_ca` or `trusted_leaf_certificate_bundle`
   must be specified.

 - `vault_client_cert_bundle` `(string: "")` - A PEM bundle of a private key
   and one or more certificates to present during authentication to the
   external policy service.

#### Sample payload

```json
{
  "enabled": true,
  "external_service_url": "https://cieps.dadgarcorp.internal",
  "trusted_ca": "-----BEGIN CERTIFICATE-----...."
}
```

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    --request POST \
    --data @payload.json \
    http://127.0.0.1:8200/v1/pki/config/external-policy
```

### Read URLs

This endpoint fetches the URLs to be encoded in generated certificates. No URL
configuration will be returned until the configuration is set.

| Method | Path               |
| :----- | :----------------- |
| `GET`  | `/pki/config/urls` |

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    http://127.0.0.1:8200/v1/pki/config/urls
```

#### Sample response

```json
{
  "lease_id": "",
  "renewable": false,
  "lease_duration": 0,
  "data": {
    "issuing_certificates": ["<url1>", "<url2>"],
    "crl_distribution_points": ["<url1>", "<url2>"],
    "ocsp_servers": ["<url1>", "<url2>"]
  },
  "auth": null
}
```

### Set URLs

This endpoint allows setting the issuing certificate endpoints, CRL distribution
points, and OCSP server endpoints that will be encoded into issued certificates.
You can update any of the values at any time without affecting the other
existing values. To remove the values, simply use a blank string as the
parameter.

| Method | Path               |
| :----- | :----------------- |
| `POST` | `/pki/config/urls` |

~> **Note**: When using multiple issuers within the same mount, it is strongly
   suggested to use the per-issuer AIA information instead of the global
   AIA information. If any of the per-issuer AIA fields are set, the entire
   issuer's preferences will be used instead. Otherwise, these fields are used
   as a fallback.<br /><br />
   This can be achieved by using _templated_ global AIA values, but setting
   the cluster-local address in configuration. When used, this value **must**
   be set on all performance replication clusters, otherwise issuance will
   fail!

#### Parameters

- `issuing_certificates` `(array<string>: nil)` - Specifies the URL values for
  the Issuing Certificate field. This can be an array or a comma-separated
  string list. See also [RFC 5280 Section 4.2.2.1](https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.2.1)
  for information about the Authority Information Access field.

- `crl_distribution_points` `(array<string>: nil)` - Specifies the URL values
  for the CRL Distribution Points field. This can be an array or a
  comma-separated string list. See also [RFC 5280 Section 4.2.1.13](https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.13)
  for information about the CRL Distribution Points field.

~> Note: When multiple Performance Replication clusters are enabled, each
   cluster will have its own CRL. Additionally, when multiple issuers are
   in use under a single mount, each issuer will also have its own CRL
   distribution point. These separate CRLs should either be aggregated into a
   single CRL (externally; as Vault does not support this functionality)
   or multiple `crl_distribution_points` should be specified here, pointing
   to each cluster and issuer.

- `ocsp_servers` `(array<string>: nil)` - Specifies the URL values for the OCSP
  Servers field. This can be an array or a comma-separated string list. See also
  [RFC 5280 Section 4.2.2.1](https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.2.1)
  for information about the Authority Information Access field.

- `enable_templating` `(bool: false)` - Specifies that the above AIA
  URL values (`issuing_certificates`, `crl_distribution_points`, and
  `ocsp_servers`) should be templated. This replaces the literal value
  `{{issuer_id}}` with the ID of the issuer doing the issuance, the
  literal value `{{cluster_path}}` with the value of `path` from the
  cluster-local configuration endpoint `/config/cluster`, and the
  literal value '{{cluster_aia_path}}' with the value of `aia_path` from
  the cluster-local configuration endpoint `/config/cluster`.

  For example, the following values can be used globally to ensure all AIA
  URIs use the cluster-local, per-issuer canonical reference, but with
  the issuing CA certificate and CRL distribution points to potentially
  use an external, non-Vault CDN.

   - `issuing_certificates={{cluster_aia_path}}/issuer/{{issuer_id}}/der`
   - `crl_distribution_points={{cluster_aia_path}}/issuer/{{issuer_id}}/crl/der`
   - `ocsp_servers={{cluster_aia_path}}/ocsp`

~> **Note**: If no cluster-local address is present and templating is used,
   issuance will fail.

#### Sample payload

```json
{
  "issuing_certificates": ["{{cluster_aia_path}}/issuer/{{issuer_id}}/der"],
  "crl_distribution_points": ["{{cluster_aia_path}}/issuer/{{issuer_id}}/crl/der"],
  "ocsp_servers": ["{{cluster_aia_path}}/ocsp"]
}
```

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    --request POST \
    --data @payload.json \
    http://127.0.0.1:8200/v1/pki/config/urls
```

### Read issuers configuration

This endpoint allows getting the value of the default issuer.

| Method | Path                  |
| :----- | :-------------------- |
| `GET`  | `/pki/config/issuers` |

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    http://127.0.0.1:8200/v1/pki/config/issuers
```

#### Sample response

```json
{
  "data": {
    "default": "3dc79a5a-7a6c-70e2-1123-94b88557ba12",
    "default_follows_latest_issuer": "false"
  }
}
```

### Set issuers configuration

This endpoint allows setting the value of the default issuer.

| Method | Path                  |
| :----- | :-------------------- |
| `POST` | `/pki/config/issuers` |
| `POST` | `/pki/root/replace`   |

#### Parameters

- `default` `(string: "")` - Specifies the default issuer (by reference;
  either a name or an ID). When no value is specified and the path is
  `/pki/root/replace`, the default value of `"next"` will be used.

- `default_follows_latest_issuer` `(bool: false)` - Specifies whether a
  root creation or an issuer import operation updates the default issuer
  to the newly added issuer.

  While the new multi-issuer functionality of 1.11 was backwards compatible
  on a per-API basis, some applications relied explicitly on unsafe behavior
  across multiple APIs that we addressed. For instance, calling
  `/intermediate/generate/:type` would silently remove any (potentially
  in-use!) key material and generate new private keys. While our response to
  this endpoint is backwards compatible (returning a new key and safely
  preserving old keys), some applications implicitly relied on this behavior.
  This new option is meant to provide compatibility across API calls to these
  callers: the newly created issuer (once _imported_ -- not on intermediate
  generation) will become the default and it will look (to anyone strictly
  using old APIs) that it is the only issuer in the mount. However, it is
  encouraged for applications to update to the newer, safer semantics
  associated with [multi-issuer rotation](/vault/docs/secrets/pki/rotation-primitives).

~> Note: When an import creates more than one new issuer with key material
   known to this mount, no default update will occur.

#### Sample payload

```json
{
  "default": "root-x1"
}
```

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    --request POST \
    --data @payload.json \
    http://127.0.0.1:8200/v1/pki/config/issuers
```

#### Sample response

```json
{
  "data": {
    "default": "3dc79a5a-7a6c-70e2-1123-94b88557ba12"
  }
}
```

### Read keys configuration

This endpoint allows getting the value of the default key.

| Method | Path               |
| :----- | :----------------- |
| `GET`  | `/pki/config/keys` |

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    http://127.0.0.1:8200/v1/pki/config/keys
```

#### Sample response

```json
{
  "data": {
    "default": "baadd98d-ec5a-66ac-06b7-dfc91c02c9cf"
  }
}
```

### Set keys configuration

This endpoint allows setting the value of the default key.

| Method | Path               |
| :----- | :----------------- |
| `POST` | `/pki/config/keys` |

#### Parameters

- `default` `(string: "")` - Specifies the default key (by reference;
  either a name or an ID).

#### Sample payload

```json
{
  "default": "baadd98d-ec5a-66ac-06b7-dfc91c02c9cf"
}
```

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    --request POST \
    --data @payload.json \
    http://127.0.0.1:8200/v1/pki/config/keys
```

#### Sample response

```json
{
  "data": {
    "default": "baadd98d-ec5a-66ac-06b7-dfc91c02c9cf"
  }
}
```

### Read cluster configuration

This endpoint fetches the cluster-local configuration.

The cluster-local config has `path`, which sets the URL to this mount on
a particular performance replication cluster. This is useful for populating
`{{cluster_path}}` during AIA URL templating, but may be used for other
values in the future.

It also has `aia_path`, which allows using a non-Vault, external responder,
setting the `{{cluster_aia_path}}` value for AIA URL templating. This is
useful for distributing CA and CRL information over an unsecured, non-TLS
channel.

| Method | Path                  |
| :----- | :-------------------- |
| `GET`  | `/pki/config/cluster` |

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    http://127.0.0.1:8200/v1/pki/config/cluster
```

#### Sample response

```json
{
  "lease_id": "",
  "renewable": false,
  "lease_duration": 0,
  "data": {
    "path": "<url>",
    "aia_path": "<url>"
  },
  "auth": null
}
```

### Set cluster configuration

This endpoint sets cluster-local configuration.

The cluster-local config has `path`, which sets the URL to this mount on
a particular performance replication cluster. This is useful for populating
`{{cluster_path}}` during AIA URL templating, but may be used for other
values in the future.

It also has `aia_path`, which allows using a non-Vault, external responder,
setting the `{{cluster_aia_path}}` value for AIA URL templating. This is
useful for distributing CA and CRL information over an unsecured, non-TLS
channel.

| Method | Path                  |
| :----- | :-------------------- |
| `POST` | `/pki/config/cluster` |

#### Parameters

- `path` `(string: "")` - Specifies the path to this performance replication
  cluster's API mount path, including any namespaces as path components.
  For example, `https://pr-a.vault.example.com/v1/ns1/pki-root`.

- `aia_path` `(string: "")` - Specifies the path to this performance replication
  cluster's AIA distribution point; may refer to an external, non-Vault responder.
  This is for resolving AIA URLs and providing the `{{cluster_aia_path}}` template
  parameter and will not be used for other purposes. As such, unlike `path` above,
  this could safely be an insecure transit mechanism (like HTTP without TLS).

#### Sample payload

```json
{
  "path": "https://...",
  "aia_path": "http://..."
}
```

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    --request POST \
    --data @payload.json \
    http://127.0.0.1:8200/v1/pki/config/cluster
```

### Read CRL configuration

This endpoint allows getting the duration for which the generated CRL should be
marked valid. No CRL configuration will be returned until the configuration is
set, but the CRL will still default to enabled with 72h expiration.

| Method | Path              |
| :----- | :---------------- |
| `GET`  | `/pki/config/crl` |

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    http://127.0.0.1:8200/v1/pki/config/crl
```

#### Sample response

```json
{
  "lease_id": "",
  "renewable": false,
  "lease_duration": 0,
  "data": {
    "disable": false,
    "expiry": "72h",
    "ocsp_disable": false,
    "ocsp_expiry": "12h",
    "auto_rebuild": false,
    "auto_rebuild_grace_period": "12h",
    "enable_delta": false,
    "delta_rebuild_interval": "15m",
    "cross_cluster_revocation": true,
    "unified_crl": true,
    "unified_crl_on_existing_paths": true
  },
  "auth": null
}
```

<a name="set-crl-configuration"></a>

### Set revocation configuration

This endpoint allows setting the duration for which the generated CRL should be
marked valid. If the CRL is disabled, it will return a signed but zero-length
CRL for any request. If enabled, it will re-build the CRL.

If the `ocsp_disable` key is set to `true`, the OCSP responder will always
respond with an Unauthorized OCSP response to any request.

~> **Note**: This parameter is global, across all clusters and issuers. Use
   the per-issuer `usage` field to disable CRL building for a specific
   issuer, while leaving the global CRL building enabled.

~> Note: Disabling the CRL does not affect whether revoked certificates are
stored internally. Certificates that have been revoked when a role's
certificate storage is enabled will continue to be marked and stored as
revoked until `tidy` has been run with the desired safety buffer. Re-enabling
CRL generation will then result in all such certificates becoming a part of
the CRL.

~> Note: Enabling automatic rebuilding of CRLs disables immediate regeneration
   on revocation. This is in line with the behavior of other CAs which only
   rebuild CRLs periodically. We suggest manually hitting the rotate if a
   fresh CRL is necessary after a revocation. For the most part though, CRLs
   should not be relied upon for the latest certificate status information,
   and OCSP should be used instead.

~> Note: The periodic function which controls automatic rebuilding of CRLs
   and delta CRLs only executes once a minute; this prevents high system load
   but limits the granularity of the temporal options below.

~> Note: The `unified_crl`, `unified_crl_on_existing_paths`, and
   `cross_cluster_revocation` parameters are all Vault Enterprise only
   functionality. While they appear in the responses on Vault OSS, they cannot
   be enabled.

| Method | Path              |
| :----- | :---------------- |
| `POST` | `/pki/config/crl` |

#### Parameters

- `expiry` `(string: "72h")` - The amount of time the generated CRL should be valid.

- `disable` `(bool: false)` - Disables or enables CRL building.

- `ocsp_disable` `(bool: false)` - Disables or enables the OCSP responder in Vault.

- `ocsp_expiry` `(string: "12h")` - The amount of time an OCSP response can be cached for,
  (controls the NextUpdate field), useful for OCSP stapling refresh durations. Setting to 0
  should effectively disable caching in third party systems.

- `auto_rebuild` `(bool: false)` - Enables or disables periodic rebuilding of
  the CRL upon expiry.

- `auto_rebuild_grace_period` `(string: "12h")` - Grace period before CRL expiry
  to attempt rebuild of CRL. Must be shorter than the CRL expiry period.

- `enable_delta` `(bool: false)` - Enables or disables building of delta CRLs
  with up-to-date revocation information, augmenting the last complete CRL.
  This option requires `auto_rebuild` to also be enabled.

- `delta_rebuild_interval` `(string: "15m")` - Interval to check for new
  revocations on, to regenerate the delta CRL. Must be shorter than CRL
  expiry.

- `cross_cluster_revocation` `(bool: false)` -
  <EnterpriseAlert product="vault" inline /> Enables cross-cluster revocation
  request queues. When a serial not issued on this local cluster is presented
  to Vault via the [`/revoke` API](#revoke-certificate), it is replicated
  across clusters and the cluster which issued that certificate will revoke
  it if it is online.

~> Note: API calls to revoke a certificate with Bring Your Own Certificate
   (BYOC) will always trigger a local revocation of that certificate. No
   cross-cluster revocation request will be created.<br /><br />
   API calls to revoke a certificate with Proof of Possession (PoP) cannot
   be satisfied if the certificate is not available locally and will
   not result in a cross-cluster revocation request. 

- `unified_crl` `(bool: false)` - 
  <EnterpriseAlert product="vault" inline /> Enables unified CRL and OCSP building. This
  synchronizes all revocations between clusters; a single, unified CRL will be
  built on the active node of the primary performance replication (PR)
  cluster. Any node in any PR cluster will be able to serve this unified CRL
  and respond to unified OCSP inquiries.

~> Note: This option ensures existing, non-expired revocations are
   consistently reported. If a certificate was issued and stored on one
   cluster, but revoked via BYOC on another, this option will inform the
   issuing cluster of the revocation.

- `unified_crl_on_existing_paths` `(bool: false)` -
  <EnterpriseAlert product="vault" inline /> Enables serving the
  unified CRL and OCSP on the existing, previously cluster-local paths
  (e.g., `/pki/crl` will now contain the unified CRL when enabled). This
  allows transitioning AIA-based consumption of CRLs to a unified view
  without having to re-issue certificates or update scripts pulling
  a single CRL.

#### Sample payload

```json
{
  "expiry": "48h",
  "disable": "false",
  "ocsp_disable": "false",
  "ocsp_expiry": "12h",
  "auto_rebuild": "true",
  "auto_rebuild_grace_period": "8h",
  "enable_delta": "true",
  "delta_rebuild_interval": "10m",
  "cross_cluster_revocation": true,
  "unified_crl": true,
  "unified_crl_on_existing_paths": true,
}
```

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    --request POST \
    --data @payload.json \
    http://127.0.0.1:8200/v1/pki/config/crl
```

### Rotate CRLs

This endpoint forces a rotation of all issuers' CRLs. This can be used by
administrators to cut the size of the CRL if it contains a number of
certificates that have now expired, but has not been rotated due to no further
certificates being revoked. If no certificates have been revoked, but the CRL
has expired or is close to expiring, administrators **must** hit this endpoint
to manually rotate the CRL. This rotates all CRLs on the present cluster,
and **must** be called on every cluster.

~> **Note**: Mirroring the behavior of earlier Vault versions, we add
   certificates revoked by an unknown issuer to the default issuer's CRL.
   To fully purge old revoked, unexpired certificates, it is not sufficient
   to delete their issuer and is instead necessary to **remove** the mount
   completely.

~> **Note**: As of Vault 1.12, it is suggested to switch to enabling the CRL's
   `auto_rebuild` functionality to avoid having to manually hit the Rotate
   endpoint when the CRL expires. This ensures a valid CRL is always
   maintained, at the expense of potentially not being up-to-date. If a
   revocation occurs that must be immediately propagated, this endpoint can
   be used to regenerate the CRL, though distribution must still occur outside
   of Vault (either manually or via AIA where supported).

| Method | Path              |
| :----- | :---------------- |
| `GET`  | `/pki/crl/rotate` |

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    http://127.0.0.1:8200/v1/pki/crl/rotate
```

#### Sample response

```json
{
  "data": {
    "success": true
  }
}
```

### Rotate delta CRLs

This endpoint forces a rotation of all issuers' delta CRLs, when enabled.
This can be used by administrators to force a rebuild of a delta CRL if
high-profile revocations have occurred and there's a long high interval
between delta rebuilds (`delta_rebuild_interval`).

See notes about rotating regular CRLs above as they apply here as well.

| Method | Path                    |
| :----- | :---------------------- |
| `GET`  | `/pki/crl/rotate-delta` |

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    http://127.0.0.1:8200/v1/pki/crl/rotate
```

#### Sample response

```json
{
  "data": {
    "success": true
  }
}
```

### Combine CRLs from the same issuer

This endpoint allows combining multiple different CRLs that have been signed by the
same issuer into a single signed CRL. This is useful to generate a single authoritative
CRL of revocations across distinct Vault clusters such as primary and performance replica
clusters.


| Method | Path                                  |
|:-------|:--------------------------------------|
| `POST` | `/pki/issuer/:issuer_ref/resign-crls` |


#### Parameters

- `issuer_ref` `(string: <required>)` - Reference to an existing issuer,
  either by Vault-generated identifier, the literal string `default` to
  refer to the currently configured default issuer, or the name assigned
  to an issuer. This parameter is part of the request URL.
- `crls` `(list of strings: <required>)` - A list of PEM encoded CRLs that have been
  signed by the issuer
- `crl_number` `(int: <required>)` - The sequence number to be written within the CRL
  Number extension.
- `delta_crl_base_number` `(int: -1)` - Using a value of 0 or greater specifies the base CRL revision
  number to encode within a Delta CRL indicator extension, otherwise the extension will
  not be added; defaults to -1.
- `format` `(string: pem)` - The format of the combined CRL, can be "pem" or "der".
  If "der", the value will be base64 encoded; Defaults to "pem".
- `next_update` `(string: 72h)` - The amount of time the generated CRL should be
  valid; defaults to 72 hours.

#### Sample payload

```json
{
  "crl_number": "10",
  "next_update": "24h",
  "crls": ["<PEM crl 1>", "<PEM crl 2>"],
  "format": "pem"
}
```

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    -request POST \
    --data @payload.json \
    http://127.0.0.1:8200/v1/pki/issuer/default/resign-crls
```

#### Sample response

```json
{
  "data": {
    "crl": "<PEM encoded crl>"
  }
}
```

### Sign revocation list

This endpoint allows generating a CRL based on the provided parameter data from any external
source and signed by the specified issuer. Values are taken verbatim from the parameters provided.

**This is a potentially dangerous endpoint and only highly trusted users should have access.**

| Method | Path                                           |
|:-------|:-----------------------------------------------|
| `POST` | `/pki/issuer/:issuer_ref/sign-revocation-list` |


#### Parameters

- `issuer_ref` `(string: <required>)` - Reference to an existing issuer,
  either by Vault-generated identifier, the literal string `default` to
  refer to the currently configured default issuer, or the name assigned
  to an issuer. This parameter is part of the request URL.
- `crl_number` `(int: <required>)` - The sequence number to be written within the CRL
  Number extension.
- `delta_crl_base_number` `(int: -1)` - Using a value of 0 or greater specifies the base CRL revision
  number to encode within a Delta CRL indicator extension, otherwise the extension will
  not be added; defaults to -1.
- `format` `(string: pem)` - The format of the combined CRL, can be "pem" or "der".
  If "der", the value will be base64 encoded; Defaults to "pem".
- `next_update` `(string: 72h)` - The amount of time the generated CRL should be
  valid; defaults to 72 hours.
- `revoked_certs` `(type: slice of maps)` - Each element contains revocation information for a
  single serial number along with the revocation time and the serial's extensions if any. Each
  element can have the following key/values
   - `serial_number` `(type: string)` - the serial number of the revoked cert
   - `revocation_time` `(type: string)` - the revocation time, unix int format or RFC3339 encoding supported
   - `extensions` `(type: slice of maps)` - A slice of all extensions that should be added to the revoked
      certificate entry. Each ele,ent contains a map with the following entries
     - `id` `(type: string)` - an ASN1 object identifier in dot notation
     - `critical` `(type: bool)` - should the extension be marked critical
     - `value` `(type: string)` - base64 encoded bytes for extension value
- `extensions` `(type: slice of maps)` - A slice of all extensions that should be added to the generated
  CRL each element containing a map with the following entries.
   - `id` `(type: string)` - an ASN1 object identifier in dot notation
   - `critical` `(type: bool)` - should the extension be marked critical
   - `value` `(type: string)` - base64 encoded bytes for extension value

~> **Note**:: The following extension ids are not allowed to be provided and can be influenced by other parameters
  - `2.5.29.20`: CRL Number
  - `2.5.29.27`: Delta CRL
  - `2.5.29.35`: Authority Key Identifier

#### Sample payload

```json
{
  "crl_number": "10",
  "next_update": "24h",
  "format": "pem",
  "revoked_certs": [
    {
      "serial_number": "39:dd:2e:90:b7:23:1f:8d:d3:7d:31:c5:1b:da:84:d0:5b:65:31:58",
      "revocation_time": "2009-11-10T23:00:00Z"
    },
    {
      "serial_number": "40:33:2e:90:b7:23:1f:8d:d3:7d:31:c5:1b:da:84:d0:5b:65:31:58",
      "revocation_time": "1257894000"
    }
  ]
}
```

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    -request POST \
    --data @payload.json \
    http://127.0.0.1:8200/v1/pki/issuer/default/sign-revocation-list
```

#### Sample response

```json
{
  "data": {
    "crl": "<PEM encoded crl>"
  }
}
```

### Tidy

This endpoint allows tidying up the storage backend and/or CRL by removing
certificates that have expired and are past a certain buffer period beyond their
expiration time.

| Method | Path        |
| :----- | :---------- |
| `POST` | `/pki/tidy` |

~> Note: it is encouraged to use the [automatic tidy capabilities](#configure-automatic-tidy)
   to ensure this gets run periodically.

#### Parameters

- `tidy_cert_store` `(bool: false)` - Specifies whether to tidy up the certificate
  store.

- `tidy_revoked_certs` `(bool: false)` - Set to true to remove all invalid and
  expired certificates from storage. A revoked storage entry is considered
  invalid if the entry is empty, or the value within the entry is empty. If a
  certificate is removed due to expiry, the entry will also be removed from the
  CRL, and the CRL will be rotated.

- `tidy_revoked_cert_issuer_associations` `(bool: false)` - Set to true to associate
  revoked certificates with their corresponding issuers; this improves the
  performance of OCSP and CRL building, by shifting work to a tidy operation
  instead.

~> Note: With multiple issuers, a CA which issued a particular revoked
   certificate may be removed and re-added, resulting in a different issuer
   ID value. When building CRLs, these links are automatically updated for any
   missing or added issuers, but during OCSP this value is computed and then
   discarded, potentially causing a performance penalty on each request.
   During regular CA operations, it is not necessary to run this operation.
   <br /><br />
   It is suggested to run this tidy when removing or importing new issuers and
   on the first upgrade to a post-1.11 Vault version, but otherwise not to run
   it during automatic tidy operations.

- `tidy_expired_issuers` `(bool: false)` - Set to true to automatically remove
  expired issuers after the `issuer_safety_buffer` duration has elapsed. We
  log the issuer certificate on removal to allow recovery; no keys are removed
  during this process.

~> Note: The default issuer will not be removed even if it has expired and is
   past the `issuer_safety_buffer` specified.

- `tidy_move_legacy_ca_bundle` `(bool: false)` - Set to true to backup any
  legacy CA/issuers bundle (from Vault versions earlier than 1.11) to
  `config/ca_bundle.bak`. This can be restored with `sys/raw` back to
  `config/ca_bundle` if necessary, but won't impact mount startup (as
  mounts will attempt to read the latter and do a migration of CA issuers
  if present). Migration will only occur after `issuer_safety_buffer` has
  passed since the last successful migration.

- `tidy_revocation_queue` `(bool: false)` - Set to true to remove stale
  revocation request entries that haven't been confirmed by any active
  node of a performance replication (PR) cluster. Only runs on the active
  node of the primary cluster.

~> Note: this tidy is only applicable on Vault Enterprise.

- `tidy_cross_cluster_revoked_certs` `(bool: false)` - Set to true to remove
  expired, cross-cluster revocation entries. This is the cross-cluster
  equivalent of `tidy_revoked_certs`. Only runs on the active node of the
  primary cluster.

~> Note: this tidy is only applicable on Vault Enterprise.

- `safety_buffer` `(string: "")` - Specifies a duration using [duration format strings](/vault/docs/concepts/duration-format)
  used as a safety buffer to ensure certificates are not expunged prematurely; as an example, this can keep
  certificates from being removed from the CRL that, due to clock skew, might
  still be considered valid on other hosts. For a certificate to be expunged,
  the time must be after the expiration time of the certificate (according to
  the local clock) plus the duration of `safety_buffer`. Defaults to `72h`.

- `issuer_safety_buffer` `(string: "")` - Specifies a duration that issuers
  should be kept for, past their `NotAfter` validity period. Defaults to
  365 days as hours (`8760h`).

- `pause_duration` `(string: "0s")` - Specifies the duration to pause
  between tidying individual certificates. This releases the revocation
  lock and allows other operations to continue while tidy is paused.
  This allows an operator to control tidy's resource utilization within
  a timespan: the LIST operation will remain in memory, but the space
  between reading, parsing, and updates on-disk cert entries will be
  increased, decreasing resource utilization.

  Does not affect `tidy_expired_issuers`.

~> Note: Using too long of a `pause_duration` can result in tidy operations
   not concluding during this lifetime! Using too short of a pause duration
   (but non-zero) can lead to lock contention. Use [tidy's cancellation](#cancel-tidy)
   to stop a running operation after the sleep period is over.

- `revocation_queue_safety_buffer` `(string: "")` - Specifies a duration
  after which cross-cluster revocation requests will be removed as expired.
  This should be set high enough that, if a cluster disappears for a while
  but later comes back, any revocation requests which it should process will
  still be there, but not too long as to fill up storage with too many invalid
  requests. Defaults to `48h`.

 - `tidy_acme` `(bool: false)` - Set to true to tidy stale ACME accounts,
   orders, authorizations, EABs, and challenges. ACME orders are tidied (deleted)
   `safety_buffer` after the certificate associated with them expires, or after
   the order and relevant authorizations have expired if no certificate was
   produced. Authorizations are tidied with the corresponding order.

   When a valid ACME Account is at least `acme_account_safety_buffer`
   old, and has no remaining orders associated with it, the account is
   marked as revoked. After another `acme_account_safety_buffer` has
   passed from the revocation or deactivation date, a revoked or
   deactivated ACME account is deleted.

 - `acme_account_safety_buffer` `(string: "720h")` - The amount of time that
   must pass after creation that an account with no orders is marked revoked,
   and the amount of time after being marked revoked or deactivated. The
   default is 30 days as hours.

#### Sample payload

```json
{
  "safety_buffer": "24h"
}
```

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    --request POST \
    --data @payload.json \
    http://127.0.0.1:8200/v1/pki/tidy
```

### Read automatic tidy configuration

This endpoint fetches the current automatic tidy configuration.

This is the combination of the periodic invocation parameters described
[in the below write handler](#set-automatic-tidy-configuration) and
the tidy parameters [described above in the tidy endpoint](#tidy).

| Method | Path                    |
| :----- | :---------------------- |
| `GET`  | `/pki/config/auto-tidy` |

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    http://127.0.0.1:8200/v1/pki/config/auto-tidy
```

#### Sample response

```json
{
  "lease_id": "",
  "renewable": false,
  "lease_duration": 0,
  "data": {
    "enabled": false,
    "interval_duration": 43200,
    "issuer_safety_buffer": 31536000,
    "maintain_stored_certificate_counts": false,
    "pause_duration": "0s",
    "publish_stored_certificate_count_metrics": false,
    "revocation_queue_safety_buffer": 172800,
    "safety_buffer": 259200,
    "tidy_cert_store": false,
    "tidy_cross_cluster_revoked_certs": false,
    "tidy_expired_issuers": false,
    "tidy_move_legacy_ca_bundle": false,
    "tidy_revocation_queue": false,
    "tidy_revoked_cert_issuer_associations": false,
    "tidy_revoked_certs": false
  },
  "auth": null
}
```

<a name="configure-automatic-tidy"></a>

### Set automatic tidy configuration

This endpoint allows configuring periodic tidy operations, using the tidy mechanism
described above. Status is from automatically run tidies are still reported at the
status endpoint described below.

| Method | Path                    |
| :----- | :---------------------- |
| `POST` | `/pki/config/auto-tidy` |

#### Parameters

The below parameters are in addition to the regular parameters accepted by the
[`/pki/tidy` endpoint](#tidy) documented above.

- `enabled` `(bool: false)` - Specifies whether automatic tidy is enabled or not.

- `interval_duration` `(string: "")` - Specifies the duration between automatic tidy
  operations; note that this is from the end of one operation to the start of
  the next so the time of the operation itself does not need to be considered.
  Defaults to 12h

- `maintain_stored_certificate_counts` `(bool: false)` - When enabled,
  maintains expensive counts of certificates. During initialization of the
  mount, a LIST of all certificates is performed to get a baseline figure and
  throughout operations like issuance, revocation, and subsequent tidies, the
  figure is updated.

~> *Note*: It is strongly recommend to not enable this value if 50k or more
   certificates are stored in the mount or if many PKI mounts are in use in
   this cluster. Instead, use audit logs and aggregate this data externally
   to Vault so as not to impact Vault performance.

- `publish_stored_certificate_count_metrics` `(bool: false)` - When enabled,
  publishes the value computed by `maintain_stored_certificate_counts` to
  the mount's metrics. This requires the former to be enabled.

#### Sample payload

```json
{
  "enabled": true,
  "tidy_revoked_cert_issuer_associations": true,
  "safety_buffer": "24h"
}
```

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    --request POST \
    --data @payload.json \
    http://127.0.0.1:8200/v1/pki/config/auto-tidy
```

### Tidy status

This is a read only endpoint that returns information about the current tidy
operation, or the most recent if none are currently running.

The result includes the following fields:

* `safety_buffer`: the value of this parameter when initiating the tidy operation
* `tidy_cert_store`: the value of this parameter when initiating the tidy operation
* `tidy_revoked_certs`: the value of this parameter when initiating the tidy operation
* `state`: one of *Inactive*, *Running*, *Finished*, *Error*, *Cancelling*, or *Cancelled*
* `error`: the error message, if the operation ran into an error
* `time_started`: the time the operation started
* `time_finished`: the time the operation finished
* `message`: One of *Tidying certificate store: checking entry N of TOTAL* or
  *Tidying revoked certificates: checking certificate N of TOTAL*
* `cert_store_deleted_count`: The number of certificate storage entries deleted
* `revoked_cert_deleted_count`: The number of revoked certificate entries deleted
* `missing_issuer_cert_count`: The number of revoked certificates which were missing a valid issuer reference
* `tidy_expired_issuers`: the value of this parameter when initiating the tidy operation
* `issuer_safety_buffer`: the value of this parameter when initiating the tidy operation
* `tidy_move_legacy_ca_bundle`: the value of this parameter when initiating the tidy operation
* `tidy_revocation_queue`: the value of this parameter when initiating the tidy operation
* `revocation_queue_deleted_count`: the number of revocation queue entries deleted
* `tidy_cross_cluster_revoked_certs`: the value of this parameter when initiating the tidy operation
* `cross_revoked_cert_deleted_count`: the number of cross-cluster revoked certificate entries deleted
* `revocation_queue_safety_buffer`: the value of this parameter when initiating the tidy operation
* `pause_duration`: the value of this parameter when initiating the tidy operation
* `last_auto_tidy_finished`: the time when the last auto-tidy operation finished; may be different than `time_finished` especially if the last operation was a manually executed tidy operation. Set to current time at mount time to delay the initial auto-tidy operation; not persisted.


| Method | Path               |
| :----- | :----------------- |
| `GET`  | `/pki/tidy-status` |

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    --request GET \
    http://127.0.0.1:8200/v1/pki/tidy-status

```

#### Sample response

```json
  "data": {
    "safety_buffer": 60,
    "tidy_cert_store": true,
    "tidy_revoked_certs": true,
    "error": null,
    "message": "Tidying certificate store: checking entry 234 of 488",
    "revoked_cert_deleted_count": 0,
    "cert_store_deleted_count": 2,
    "state": "Running",
    "time_started": "2021-10-20T14:52:13.510161-04:00",
    "time_finished": null
  },
```

### Cancel tidy

This endpoint allows cancelling a running tidy operation. It takes no
parameter and cancels the tidy at the next available checkpoint, which
may process additional certificates between when the operation was
marked as cancelled and when the operation stopped.

The response to this endpoint is the same as the [status](#tidy-status).

| Method | Path               |
| :----- | :----------------- |
| `POST` | `/pki/tidy-cancel` |

#### Sample request

```shell-session
$ curl \
    --header "X-Vault-Token: ..." \
    --request POST \
    http://127.0.0.1:8200/v1/pki/tidy-cancel

```

#### Sample response

```json
  "data": {
    "safety_buffer": 60,
    "tidy_cert_store": true,
    "tidy_revoked_certs": true,
    "error": null,
    "message": "Tidying certificate store: checking entry 234 of 488",
    "revoked_cert_deleted_count": 0,
    "cert_store_deleted_count": 2,
    "state": "Cancelling",
    "time_started": "2021-10-20T14:52:13.510161-04:00",
    "time_finished": null
  },
```
