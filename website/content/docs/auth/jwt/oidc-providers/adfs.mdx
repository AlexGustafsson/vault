---
layout: docs
page_title: OIDC Provider Setup - Auth Methods - ADFS
description: OIDC provider configuration for ADFS
---

# ADFS

This documentation will help you configure your ADFS and Vault to work together to use your ADFS accounts to log in to Vault.

## Step 1: Configure your Windows ADFS

On your Windows Server UI, on the Server Manager, Click on **Tools **and select **AD FS Management**

1. On the bar on the left right-click on **Application Groups** → **Add Application Group…**
    1. Name: Vault
    2. Description: Set a quick description
    3. Select **Server application**
    4. Click on **Next**
    5. Copy your **Client Identifier**, we will use it later (on the configuration of the Web API and the Vault OIDC) 
      <Tip title="Example">
      d879d6fb-d2de-4596-b39c-191b2f83c03f
      </Tip>
    6. **Redirect URI** set: add your vault address and `http://localhost:8250/oidc/callback`
      <Tip title="Example">
        https://vault.example.com:8200/ui/vault/auth/adfs/oidc/callback <br/>
      </Tip>
      <Note>
        If you customize the path in Step 2 - 2.2 https://vault.example.com:8200/ui/vault/auth/YOUR_PATH/oidc/callback
      </Note>
      <Highlight title="Information">  
      The <strong>http://localhost:8250/oidc/callback</strong> address enables the Vault CLI to login via the OIDC method.
      </Highlight>
      
    7. Click on **Next**
    8. Check the box **Generate a shared secret** and copy it (you will need it later)
    9. Click on **Next**
    10. Review the information and click on **Next** and **Close**
2. Double Click on the application group you created (Vault)
    1. Click on **Add application…**
    2. Select **Web API** and click on **Next**
    3. As Identifier use the **Client Identifier** you copied earlier and click on **Add** and **Next**
      <Tip title="Example">
      From Step 1 - 1.5: d879d6fb-d2de-4596-b39c-191b2f83c03f
      </Tip>
    4. Select `Permit everyone` (you can choose the right access control policy for you) and click on **Next**
    5. Select `allatclaims`, `email`, `openid` and `profile` and click on **Next**
    6. Review the information and click on **Next **and** Close**
3. Back on the **Vault Properties** window, Double click on the Web API you just created: **Vault - Web API**
    1. Navigate to the tab **Issuance Transform Rules** and click on **Add Rule…**
    2. Select **Send LDAP Attributes as Claims** and click on **Next**
    3. As Claim rule name: "**LDAP Group**"
    4. On Attribute store, select **Active Directory**
    5. On the LDAP Attribute, select **Token-Groups - Unqualified Names**
    6. On the Outgoing Claim Type: **Group**
      
      [![Screenshot of the Transform Claim Rule Configuration](/img/adfs-oidc-ldapgroupoption.png)](/img/adfs-oidc-ldapgroupoption.png)

    7. Click on **Finish** → Click on **OK** 2 times

Your ADFS is configured, now we are going to configure Vault 

## Step 2: Enable OIDC auth method

Preparing your shell
- Set your Vault Address
  ```shell-session
  $ export VAULT_ADDR="Your_Vault_Address"
  ```
- Set your Vault Token
  ```shell-session
  $ export VAULT_TOKEN="Your_Vault_Token"
  ```
- Set your Vault Namespace
  <Tip>
    Only if you are using <strong>Vault Enterprise</strong> or <strong>HCP Vault</strong>
  </Tip>

  ```shell-session
  $ export VAULT_NAMESPACE="Your_Vault_Namespace"
  ```

<Tabs>

<Tab heading="CLI command">

1. Enable the **OIDC** auth method at the path adfs (you can customize the path).

  ```shell-session
    $ vault auth enable -path=/adfs oidc
  ```

  <Note>
    If you customize the path do not forget to <strong>change the path in Step1: 1.6, Step 3 and Step 5</strong><br/>
    Example: https://vault.example.com:8200/ui/vault/auth/YOUR_PATH/oidc/callback
  </Note>

2. Configure the oidc auth method.
    
  ```shell-session
    $ vault write auth/adfs/config \
      oidc_discovery_url="https://adfs.example.com/adfs" \
      oidc_client_id="Your_Client_Identifier" \
      oidc_client_secret="Your_Secret" \
      default_role="adfs-default" 
  ```

  <Note>
    <strong>Your_Client_Identifier</strong> and <strong>Your_Secret</strong> came from the ADFS Step 1 - 1.5 and 1.8
  </Note>

The default role will be defined on the next Step.

</Tab>

<Tab heading="Web UI">
On the UI of Vault:

1. On the left bare, click on **Access**
2. On the new page on the right click on **Enable new method** 
3. Select **OIDC **and click on **Next**
4. In the path set adfs
5. Click on **Enable Method**

    - Complete **OIDC discovery URL** 
      <Tip title="Example">
        https://adfs.example.com/adfs
      </Tip>
    - Set the **Default role** to **adfs-default**
    <Tip>The <strong>Default role</strong> is customizable and will be created in the next Step</Tip>

6. Open **OIDC Options** and set your OIDC information:
    - Set **OIDC client ID** with Your_Client_Identifier.
    - Set **OIDC client secret** with Your_Secret previously generated in your ADFS.
    <Note><strong>Your_Client_Identifier</strong> and <strong>Your_Secret</strong> came from the ADFS Step 1 - 1.5 and 1.8</Note>
7. Click **Save** to apply your changes.

</Tab>

</Tabs>

## Step 3: Create a role

We will create a role for the users of Vault:

Replace **OIDC client ID** with your information

```shell-session
$ vault write auth/adfs/role/adfs-default \
  bound_audiences="Your_Client_Identifier" \
  allowed_redirect_uris="$VAULT_ADDR/ui/vault/auth/adfs/oidc/callback" \
  allowed_redirect_uris="http://localhost:8250/oidc/callback" \
  user_claim="upn" groups_claim="group" token_policies="default"
```

<Highlight title="Information">
<ul><li>The <strong>upn</strong> in user_claim is referring to the email of the user in the token.</li>
<li>The <strong>http://localhost:8250/oidc/callback</strong> address enables the Vault CLI to login via the OIDC method.</li></ul>
</Highlight>

## Step 4: Create secret engine and an associated policy (Optional)

1. Create your secret engine

  ```shell-session
  $ vault secrets enable -path=my-test-adfs kv-v2
  ```

2. Set a secret
  ```shell-session
  $ vault kv put my-test-adfs/customer customer_name="ACME Inc."
  ```
  
3. Create a policy to read and list the secret previously added

  ```shell-session
  $ vault policy write read-my-test-adfs - << EOF
  # Policy to be able to read secrets inside my-test-adfs
  path "my-test-adfs/*" {
    capabilities = ["read", "list"]
  }
  EOF
  ```

## Step 5: Link AD groups to Vault

<Tabs>

<Tab heading="CLI command">

### Create Groups for Vault and link it to the group of ADFS

1. Create a Vault External group and save its id in a file named group_id.txt.

  ```shell-session
  $ vault write -format=json identity/group name="name of the group" \
    policies="read-my-test-adfs" \
    type="external" | jq -r ".data.id" > group_id.txt
  ```
  <Tip>
    You can change <strong>read-my-test-adfs</strong> to a list of policies associated to this group
  </Tip>
2. Retrieve the mount accessor for the ADFS auth method and save it in a file named accessor_adfs.txt.

  ```shell-session
  $ vault auth list -format=json | jq -r '.["adfs/"].accessor' > accessor_adfs.txt
  ```

3. Create a group alias.

  ```shell-session
  $ vault write identity/group-alias name="Group Existing in your ADFS" \
    mount_accessor=$(cat accessor_adfs.txt) \
    canonical_id="$(cat group_id.txt)"
  ```

4. Attempt to login as an ADFS user who is a member of the group you specified as Alias

</Tab>

<Tab heading="Web UI">

1. Create Vault External groups
    1. On the left bar click on **Access**
    2. On the left bar click on **Groups**
    3. Click on **Create group**
2. You must fill in the following fields
    - Name: Name of the group on vault (customizable)
    - Type: `external`
    - Policies: policies you want to link to the group
    <Tip title="Example">
      If you did Step 4 you can use: <strong>read-my-test-adfs</strong>
    </Tip>
3. Click on **Create**

We need to create an Alias to be able to map the vault group created previously to an existing group on your ADFS

1. Click on **Add alias**
    - Name: Must match to an existing group for your user on your ADFS
    - Auth Backend: **adfs/ (oidc)**
    <Note>
      If you customize the path in Step 2 <strong>select the right Auth Backend</strong>
    </Note>
2. Attempt to login as an ADFS user who is a member of the group you specified as Alias

</Tab>

</Tabs>
